# 更新日志 (CHANGELOG)

## [v1.0] - 2026-02-02

### 🎉 新增功能

#### 1. 世界切换系统
- ✅ 实现了现实世界 (Reality) 与意识世界 (Consciousness) 的双向切换
- ✅ 基于解离度 (Dissociation) 的切换条件判断
  - Reality → Consciousness：解离度 ≥ 90
  - Consciousness → Reality：解离度 ≤ 10
- ✅ 床交互作为世界切换的触发点

#### 2. 视觉转场效果
- ✅ 闭眼/睁眼转场动画系统 (EyeBlinkTransition)
  - 闭眼时间：1.5秒
  - 黑屏停留：1.0秒
  - 睁眼时间：2.0秒
  - 总转场时长：4.5秒
- ✅ 使用平滑曲线实现自然的视觉过渡
- ✅ 黑屏期间完成场景切换，玩家无感知加载过程

#### 3. 音乐系统
- ✅ 世界音乐管理器 (WorldMusicManager)
  - 现实世界音乐：There's Something Outside (loop)
  - 意识世界音乐：流亡
- ✅ 音乐平滑过渡
  - 淡出时间：1.5秒（与闭眼动画同步）
  - 淡入时间：2.0秒（与睁眼动画同步）
- ✅ 使用 SmoothStep 曲线实现自然的音量变化
- ✅ 音乐在转场开始时就切换，确保无缝衔接

#### 4. 玩家位置管理
- ✅ 玩家位置管理器 (PlayerPositionManager)
- ✅ 为每个世界独立保存玩家位置
- ✅ 场景切换时自动恢复玩家位置
- ✅ 床位置作为世界切换后的出生点
- ✅ 自动重置玩家速度，防止掉落或飞行

#### 5. 心理数值系统
- ✅ 心理数值管理器 (MentalStatsManager)
- ✅ 管理压力值 (Stress) 和解离度 (Dissociation)
- ✅ 自动变化机制：
  - 压力 = 100 时，解离度自动增加
  - 压力 = 0 时，解离度自动减少

#### 6. 测试工具
- ✅ 世界切换测试工具 (WorldSwitchTester)
- ✅ 运行时快速调整解离度
- ✅ 屏幕显示当前状态和切换条件
- ✅ 快捷键支持：
  - PageUp：增加解离度
  - PageDown：减少解离度
  - 9：解离度设为 100
  - 0：解离度设为 0

### 🔧 技术实现

#### 系统架构
- ✅ 单例模式管理全局系统
- ✅ DontDestroyOnLoad 保持跨场景对象
- ✅ 事件驱动的系统通信
- ✅ 协程实现异步转场效果

#### 代码组织
- ✅ 命名空间：SeeAPsychologist.WorldState
- ✅ 清晰的代码注释和文档
- ✅ 配置文件驱动的参数管理

### 🎨 用户体验优化

#### 转场体验
- ✅ 4.5秒的舒适转场时长
- ✅ 视觉和听觉完美同步
- ✅ 平滑的淡入淡出效果
- ✅ 无加载感知的场景切换

#### 交互反馈
- ✅ 详细的 Console 日志输出
- ✅ 解离度不足时的提示
- ✅ 屏幕显示当前状态（测试模式）

### 📁 文件结构

#### 新增脚本
```
Assets/Scripts/WorldState/
├── WorldStateManager.cs          # 世界状态管理器
├── WorldStateConfig.cs            # 世界状态配置
├── BedWorldSwitchInteractable.cs # 床交互切换器
├── WorldMusicManager.cs           # 音乐管理器
├── EyeBlinkTransition.cs          # 转场效果
├── PlayerPositionManager.cs       # 玩家位置管理器
├── WorldSwitchTester.cs           # 测试工具
├── WorldType.cs                   # 世界类型枚举
├── InteractionType.cs             # 交互类型枚举
└── WorldSwitchedEvent.cs          # 世界切换事件

Assets/Scripts/MentalStats/
├── MentalStatsManager.cs          # 心理数值管理器
├── MentalStatsConfig.cs           # 心理数值配置
└── MentalStatChangeSource.cs      # 数值变化来源枚举
```

#### 新增资源
```
Assets/Audio/
├── There's Something Outside(loop).wav  # 现实世界音乐
└── 流亡.wav                              # 意识世界音乐

Assets/Resources/
├── WorldStateConfig.asset         # 世界状态配置
└── MentalStatsConfig.asset        # 心理数值配置

Assets/Scenes/
├── Reality.unity                  # 现实世界场景
└── Consciousness.unity            # 意识世界场景
```

### 🎯 核心特性

#### 1. 沉浸式世界切换
- 玩家在床上"睡觉"，通过闭眼/睁眼切换世界
- 音乐和视觉完美同步，营造梦境般的体验
- 玩家在床的位置醒来，保持空间连续性

#### 2. 基于心理状态的切换机制
- 解离度决定能否进入意识世界
- 压力值影响解离度的自动变化
- 符合游戏的心理题材设定

#### 3. 无缝的场景过渡
- 黑屏期间完成场景加载
- 音乐提前切换，避免断层
- 玩家位置自动恢复，无传送感

### 📊 性能优化

- ✅ 使用协程避免阻塞主线程
- ✅ 单例模式减少对象创建
- ✅ 事件系统降低耦合度
- ✅ 配置文件减少硬编码

### 🐛 已知问题

- 无

### 📝 开发笔记

#### 设计决策
1. **转场时长**：选择 4.5秒是为了给玩家足够的心理准备时间，避免突兀感
2. **音乐提前切换**：在闭眼开始时就切换音乐，确保睁眼时新音乐已经在播放
3. **床位置作为出生点**：让玩家感觉在"同一张床"上醒来，增强沉浸感
4. **解离度阈值**：10 和 90 的阈值设计留出中间区间，避免频繁切换

#### 技术挑战与解决
1. **音乐切换时机**：通过在 BedWorldSwitchInteractable 中提前调用 PrepareMusicForWorld 解决
2. **玩家位置恢复**：使用协程延迟恢复，确保场景对象初始化完成
3. **时序问题**：通过 Awake/Start 的执行顺序和多帧等待解决

### 🔮 未来计划

#### 可能的扩展
- [ ] 更多世界类型（梦境、回忆等）
- [ ] 更复杂的切换条件（剧情触发、特殊物品等）
- [ ] 更多转场效果（淡入淡出、扭曲、粒子等）
- [ ] 世界特有的视觉效果（滤镜、后处理等）
- [ ] 音乐的动态混合和分层

#### 优化方向
- [ ] 转场效果的可配置性
- [ ] 更精细的音乐控制
- [ ] 玩家位置的更智能管理
- [ ] 性能监控和优化

---

## 版本信息

**版本号**：v1.0  
**发布日期**：2026年2月2日  
**开发者**：AI Assistant + 项目团队  
**引擎版本**：Unity 2022.x

---

## 致谢

感谢所有参与开发和测试的团队成员！

特别感谢：
- Tarodev 2D Controller 提供的玩家控制系统
- Fungus 提供的对话系统
- 音乐创作者提供的优秀配乐

---

**下一个版本预计**：待定  
**反馈渠道**：项目仓库 Issues

