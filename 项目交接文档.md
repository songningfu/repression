# Subconscious Echo Studio - 项目交接文档

## 项目概述

**项目名称**：Subconscious Echo Studio (看心理医生)  
**类型**：2D 心理题材游戏  
**核心机制**：现实世界与意识世界的切换系统

## 核心系统架构

### 1. 世界状态管理系统 (WorldState)

#### 主要组件

**WorldStateManager** - 世界状态管理器
- 位置：`Assets/Scripts/WorldState/WorldStateManager.cs`
- 功能：管理当前世界状态，处理世界切换逻辑
- 单例模式，DontDestroyOnLoad
- 依赖：WorldStateConfig (Resources/WorldStateConfig)

**WorldStateConfig** - 世界配置
- 位置：`Assets/Resources/WorldStateConfig.asset`
- 配置项：
  - 场景名称：Reality / Consciousness
  - 解离度阈值：bedEnterRealityMaxDissociation (10) / bedEnterConsciousnessMinDissociation (90)

**BedWorldSwitchInteractable** - 床交互切换器
- 位置：`Assets/Scripts/WorldState/BedWorldSwitchInteractable.cs`
- 功能：处理床的交互，根据解离度判断是否切换世界
- 挂载在：两个场景的床对象上

### 2. 音乐管理系统

**WorldMusicManager** - 世界音乐管理器
- 位置：`Assets/Scripts/WorldState/WorldMusicManager.cs`
- 功能：根据当前世界自动播放对应背景音乐
- 音乐文件：
  - 现实世界：`Assets/Audio/There's Something Outside(loop).wav`
  - 意识世界：`Assets/Audio/流亡.wav`
- 特性：
  - 淡入淡出时间：1.5秒淡出 / 2.0秒淡入
  - 平滑曲线过渡
  - 在转场动画开始时就切换音乐

### 3. 视觉转场系统

**EyeBlinkTransition** - 闭眼/睁眼转场效果
- 位置：`Assets/Scripts/WorldState/EyeBlinkTransition.cs`
- 功能：提供闭眼/睁眼的视觉转场效果
- 时间配置：
  - 闭眼时间：1.5秒
  - 黑屏停留：1.0秒
  - 睁眼时间：2.0秒
  - 总时长：4.5秒

### 4. 玩家位置管理系统

**PlayerPositionManager** - 玩家位置管理器
- 位置：`Assets/Scripts/WorldState/PlayerPositionManager.cs`
- 功能：为每个世界分别保存和恢复玩家位置
- 特性：
  - 独立保存每个世界的玩家位置
  - 场景切换时自动恢复位置
  - 重置玩家速度，防止掉落

### 5. 心理数值系统 (MentalStats)

**MentalStatsManager** - 心理数值管理器
- 位置：`Assets/Scripts/MentalStats/MentalStatsManager.cs`
- 管理数值：
  - Stress (压力值)：0-100
  - Dissociation (解离度)：0-100
- 自动变化规则：
  - 压力 = 100：解离度自动增加
  - 压力 = 0：解离度自动减少

### 6. 测试工具

**WorldSwitchTester** - 世界切换测试工具
- 位置：`Assets/Scripts/WorldState/WorldSwitchTester.cs`
- 功能：运行时快速调整解离度，方便测试
- 快捷键：
  - PageUp：增加解离度
  - PageDown：减少解离度
  - 9：解离度 → 100
  - 0：解离度 → 0

## 场景结构

### Reality 场景 (现实世界)
- 场景文件：`Assets/Scenes/Reality.unity`
- 必需对象：
  - 床对象 (带 BedWorldSwitchInteractable)
  - 玩家对象 (Tag: Player)

### Consciousness 场景 (意识世界)
- 场景文件：`Assets/Scenes/Consciousness.unity`
- 必需对象：
  - 床对象 (带 BedWorldSwitchInteractable)
  - 玩家对象 (Tag: Player)

### 全局对象 (DontDestroyOnLoad)
这些对象在第一个场景中创建，会在场景切换时保持存在：
- WorldStateManager
- PlayerPositionManager
- WorldMusicManager
- EyeBlinkTransition
- MentalStatsManager

## 工作流程

### 世界切换完整流程

1. **玩家与床互动**
   - 检查当前解离度
   - 判断是否满足切换条件

2. **开始转场**
   - 保存床位置为目标世界出生点
   - 开始闭眼动画 (1.5秒)
   - 音乐开始淡出 (1.5秒)

3. **黑屏期间**
   - 黑屏停留 (1.0秒)
   - 加载目标场景
   - 切换音乐文件

4. **场景加载完成**
   - 恢复玩家位置到床的位置
   - 开始睁眼动画 (2.0秒)
   - 音乐开始淡入 (2.0秒)

5. **转场完成**
   - 玩家在新世界的床位置
   - 新世界的音乐播放
   - 可以继续游戏

### 解离度与世界切换

- **Reality → Consciousness**：需要解离度 ≥ 90
- **Consciousness → Reality**：需要解离度 ≤ 10
- **中间区间 (11-89)**：无法切换

## 开发注意事项

### 1. 添加新场景
如果需要添加新的世界场景：
1. 在 WorldStateConfig 中配置场景名称
2. 确保场景中有床对象和玩家对象
3. 床对象需要挂载 BedWorldSwitchInteractable

### 2. 调整转场时间
如果需要调整转场速度：
1. 修改 EyeBlinkTransition 的时间参数
2. 同步修改 WorldMusicManager 的淡入淡出时间

### 3. 调整解离度阈值
在 WorldStateConfig 中修改：
- bedEnterRealityMaxDissociation
- bedEnterConsciousnessMinDissociation

### 4. 测试世界切换
使用 WorldSwitchTester：
1. 在场景中添加 WorldSwitchTester 对象
2. 运行游戏，使用快捷键调整解离度
3. 测试完成后删除该对象

## 依赖资源

### 音频资源
- `Assets/Audio/There's Something Outside(loop).wav` - 现实世界音乐
- `Assets/Audio/流亡.wav` - 意识世界音乐

### 配置资源
- `Assets/Resources/WorldStateConfig.asset` - 世界状态配置
- `Assets/Resources/MentalStatsConfig.asset` - 心理数值配置

### 第三方插件
- Fungus - 对话系统
- Tarodev 2D Controller - 玩家控制器

## 常见问题

### Q: 世界切换后玩家不在床位置？
A: 检查 PlayerPositionManager 是否存在，玩家对象的 Tag 是否为 "Player"

### Q: 无法切换世界？
A: 检查当前解离度是否满足切换条件，使用 WorldSwitchTester 调整解离度测试

### Q: 音乐没有切换？
A: 检查 WorldMusicManager 是否存在，音频文件是否正确配置

### Q: 转场效果不流畅？
A: 调整 EyeBlinkTransition 和 WorldMusicManager 的时间参数

## 联系信息

如有问题，请查看代码注释或联系前任开发者。

---

**最后更新**：2026年2月2日  
**版本**：v1.0

